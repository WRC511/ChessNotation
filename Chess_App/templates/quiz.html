{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- Score Display -->
            <div class="text-center mb-4">
                <h3>Score: <span id="score">0</span>/5</h3>
            </div>

            <!-- Chessboard Container -->
            <div id="board" class="mb-4" style="width: 400px; margin: 0 auto;"></div>

            <!-- Question Container -->
            <div id="question-container" class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title" id="question-text"></h4>
                    <div id="options-container" class="mt-3">
                        <!-- Options will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Feedback Container -->
            <div id="feedback-container" class="alert d-none">
                <p id="feedback-text"></p>
                <button id="next-question" class="btn btn-primary mt-2">Next Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<script>
    // Wait for DOM to be fully loaded
    $(document).ready(function() {
        // Get questions from server
        const allQuestions = {{ quiz_questions|tojson|safe }};

        // Randomly select 5 questions when the quiz starts
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        const questions = shuffleArray([...allQuestions]).slice(0, 5);

        let currentQuestion = 0;
        let score = 0;
        let game = new Chess();
        let board = null;
        let animationTimer = null;

        function initializeBoard() {
            // Destroy existing board if it exists
            if (board) board.destroy();
            
            const config = {
                draggable: false,
                showNotation: true,
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            
            // Initialize the board
            board = Chessboard('board', config);
            
            // Initialize the game
            game = new Chess();
        }

        function displayQuestion() {
            if (currentQuestion >= 5) {
                showResults();
                return;
            }

            // Clear any existing animation timer
            if (animationTimer) {
                clearInterval(animationTimer);
                animationTimer = null;
            }

            const question = questions[currentQuestion];
            $('#question-text').text(question.question);
            
            const optionsContainer = $('#options-container');
            optionsContainer.empty();
            
            question.options.forEach((option, index) => {
                const button = $('<button>')
                    .addClass('btn btn-outline-primary btn-block mb-2')
                    .text(option)
                    .click(() => checkAnswer(index));
                optionsContainer.append(button);
            });

            // Reset the game and board
            game = new Chess();
            
            // Check if this is an algebraic notation question (index 6-10)
            if (question.index <= 5) {
                // Load the specific position and animate the move
                if (game.load(question.startFen)) {
                    // Show initial position
                    board.position(question.startFen, false);
                    
                    // Create animation sequence
                    let isShowingMove = false;
                    
                    animationTimer = setInterval(() => {
                        if (!isShowingMove) {
                            // Show the move
                            game = new Chess(question.startFen);
                            const moveResult = game.move({
                                from: question.move.from,
                                to: question.move.to,
                                promotion: question.move.promotion || 'q'
                            });
                            
                            if (moveResult) {
                                board.position(game.fen(), true);
                                isShowingMove = true;
                            } else {
                                console.error('Invalid move:', question.move);
                            }
                        } else {
                            // Reset to starting position
                            board.position(question.startFen, true);
                            isShowingMove = false;
                        }
                    }, 2000); // Toggle every 2 seconds
                } else {
                    console.error('Invalid FEN:', question.startFen);
                    board.start();
                }
            } else {
                // For conceptual questions, just show the starting position
                board.start();
            }
        }

        function checkAnswer(selectedIndex) {
            // Clear animation when answering
            if (animationTimer) {
                clearInterval(animationTimer);
                animationTimer = null;
            }

            const question = questions[currentQuestion];
            const feedbackContainer = $('#feedback-container');
            const feedbackText = $('#feedback-text');
            
            if (selectedIndex === question.correct) {
                score++;
                $('#score').text(score);
                feedbackContainer.removeClass('alert-danger').addClass('alert alert-success');
                feedbackText.text('Correct! ' + question.explanation);
            } else {
                feedbackContainer.removeClass('alert-success').addClass('alert alert-danger');
                feedbackText.text('Incorrect. ' + question.explanation);
            }
            
            feedbackContainer.removeClass('d-none');
            $('#options-container').hide();

            // Show the final position after answering for notation questions
            if (question.index <= 5) {
                game = new Chess(question.startFen);
                game.move({ from: question.move.from, to: question.move.to, promotion: question.move.promotion || 'q' });
                board.position(game.fen(), false);
            }
        }

        function showResults() {
            $('.container').html(`
                <div class="text-center">
                    <h2>Quiz Complete!</h2>
                    <h3>Your final score: ${score}/5</h3>
                    <p>${getScoreMessage()}</p>
                    <button onclick="location.reload()" class="btn btn-primary">Try Again</button>
                </div>
            `);
        }

        function getScoreMessage() {
            if (score === 5) return "Perfect! You're a chess master!";
            if (score >= 3) return "Good job! You know your chess!";
            return "Keep practicing! You'll get better!";
        }

        $('#next-question').click(function() {
            currentQuestion++;
            $('#feedback-container').addClass('d-none');
            $('#options-container').show();
            displayQuestion();
        });

        // Initialize the quiz
        initializeBoard();
        displayQuestion();
    });
</script>

<style>
    .btn-block {
        width: 100%;
    }
    #board {
        margin-bottom: 20px;
    }
    .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}
